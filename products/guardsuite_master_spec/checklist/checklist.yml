# products/guardsuite_master_spec/checklist/checklist.yml
# Strategy-D canonical checklist for the GuardSuite master spec and checklist registry service

metadata:
  product_id: guardsuite_master_spec
  checklist_version: "2026.04"
  last_updated: "2025-11-25T00:00:00Z"
  owner: "GuardSuite Platform Team"
  stability: ga

structure_requirements:
  - id: STRUCT-GMSTR-001
    description: "Preserve every source section, bullet, and descriptive line from the historical master spec file."
    required: true
  - id: STRUCT-GMSTR-002
    description: "Apply Strategy-D ordering: metadata ⇒ canonical requirement sections ⇒ phases ⇒ legacy snapshot."
    required: true
  - id: STRUCT-GMSTR-003
    description: "Document governance, schema, and API expectations before enumerating operational phases."
    required: true

documentation_requirements:
  readme_required: true
  product_docs_required: true
  api_reference_required: true
  examples_required: true
  changelog_required: true
  release_notes_required: true

schema_requirements:
  canonical_schema_required: true
  metadata_schema_required: true
  provenance_schema_required: true
  fragment_schemas_required: true
  additional_schemas:
    - schemas/product_schema.yml
    - schemas/checklist_schema.yml
    - schemas/gpt_instructions_schema.yml
    - schemas/bootstrap_schema.yml
    - schemas/cli_output.json
    - schemas/cli_error.json
    - schemas/fixpack_schema.yml

evaluator_requirements:
  pipeline_must_match_template: true
  canonicalization_required: true
  wasm_safety_required: true
  deterministic_output_required: true
  timestamp_normalization_required: true
  prohibited_overrides:
    - canonical.output_contract
    - engine.payload_serializer
    - evaluator.stage_order
    - bootstrap.generator_contract

fixpack_requirements:
  fixpack_catalog_required: false
  fixpack_metadata_required: false
  difficulty_taxonomy_required: false
  patch_hashing_required: false
  remediation_examples_required: false

testing_requirements:
  unit_tests_required: true
  integration_tests_required: true
  snapshot_tests_required: true
  parity_tests_required: true
  wasm_tests_required: false
  schema_validation_tests_required: true
  performance_tests_required: true
  minimum_coverage_percent: 85

artifacts:
  required_files:
    - repos/guard-specs/spec.yml
    - products/guardsuite_master_spec/checklist/checklist.yml
    - schemas/product_schema.yml
    - schemas/checklist_schema.yml
    - schemas/gpt_instructions_schema.yml
    - schemas/bootstrap_schema.yml
    - schemas/cli_output.json
    - schemas/cli_error.json
    - openapi.yaml
    - docs/migrations/
  required_directories:
    - repos/guard-specs
    - schemas
    - docs
    - bootstraps
    - ci
    - scripts
    - tests
  build_outputs:
    - bootstraps/*.json
    - artifacts/validation_reports

acceptance_criteria:
  - id: ACPT-GMSTR-001
    description: "End-to-end flow: create product → validate → generate bootstrap → Architect consumes artifact."
    required: true
  - id: ACPT-GMSTR-002
    description: "Determinism: repeated bootstrap generation with identical inputs yields identical hashes (3x)."
    required: true
  - id: ACPT-GMSTR-003
    description: "Governance: schema change flow, migration guide, and downstream notifications exist for every major bump."
    required: true
  - id: ACPT-GMSTR-004
    description: "Security: RBAC enforced for writes, webhook signatures validated, and no literal secrets stored."
    required: true
  - id: ACPT-GMSTR-005
    description: "Docs: authoring guide, API reference, and migration templates published and validated."
    required: true

cross_product_dependencies:
  depends_on_products:
    - guardsuite-core
    - guard-template
    - guardboard
  depends_on_schemas:
    - schemas/product_schema.yml
    - schemas/checklist_schema.yml
    - schemas/bootstrap_schema.yml
  depends_on_pipeline: true

provenance:
  - "Derived from the GuardSuite Specs charter dated 2025-11-24."
  - "Aligned with guardsuite-template evaluator and governance invariants."
  - "Backed by the deterministic bootstrap artifact contract."

id: guardsuite_master_spec_checklist
version: "2026.04"
product: guardsuite_master_spec
pillar: platform
spec_source: "products/guardsuite_master_spec/spec.yml"

phases:

  # ============================================================
  # PHASE 1 — MISSION, PURPOSE, AND SCOPE
  # ============================================================
  - phase: mission_and_scope
    summary: "Codify mission, purpose, principles, and scope boundaries for guard-specs."
    items:
      - id: MSPEC-001
        title: "Mission statements"
        tasks:
          - |
            mission:
              - "Be the canonical source-of-truth for product specs, checklists, and gpt-instructions across GuardSuite."
              - "Produce deterministic, validated, versioned bootstrap artifacts consumable by Architect sessions and tooling."
              - "Enforce schema-first governance, versioning discipline, and lifecycle management across the suite."
      - id: MSPEC-002
        title: "Purpose summary"
        tasks:
          - |
            purpose:
              summary: >
                guard-specs stores product YAML specs and checklists, validates them against the schema registry,
                generates deterministic bootstrap artifacts (spec + checklist + gpt-instructions + session skeleton),
                exposes programmatic APIs and CLI for CI/Architect consumption, and manages governance and migrations.
      - id: MSPEC-003
        title: "Principles"
        tasks:
          - |
            principles:
              - "Schema-first: all public shapes live under /schemas and are versioned."
              - "Determinism: identical inputs must produce identical bootstrap artifacts."
              - "Governance: breaking changes require migration guides and downstream pinning."
              - "No secrets: specs must not contain secrets; secrets are external references."
              - "Auditability: every change must be recorded with actor, timestamp, and diff."
      - id: MSPEC-004
        title: "Scope"
        tasks:
          - |
            scope:
              responsibilities:
                - authoritative storage of product specs, checklists, and gpt-instructions
                - schema registry and schema validation service
                - deterministic bootstrap artifact generation and versioning
                - API and CLI for product lifecycle operations (create, update, validate, generate)
                - scheduler for periodic/regenerative bootstrap generation
                - webhook ingestion for Implementor #FEEDBACK_CONTRACT and CI audit results
                - governance workflows (deprecation, migration, version pinning)
                - artifact storage, metadata DB, and backup
              out_of_scope:
                - runtime execution of pillar code (concrete pillars run their own code)
                - platform network gateway and auth proxy (handled by platform/gateway)
                - secret manager storage for sensitive values (use external secret manager)

  # ============================================================
  # PHASE 2 — GOVERNANCE & VERSIONING
  # ============================================================
  - phase: governance_and_versioning
    summary: "Capture responsibility matrix, versioning policy, and governance commitments."
    items:
      - id: MSPEC-005
        title: "Responsibility matrix"
        tasks:
          - |
            responsibility_matrix:
              canonical_serializer: guardsuite-core (future)
              evaluator_pipeline: guard-template (implementation) / concrete pillars (consumers)
              issue_model: guardsuite-core (future) / dev-shim (template)
              rule_bundles: concrete pillars
              fixpacks: concrete pillars (catalog indexed by guard-specs)
              schemas: guard-specs (registry) + guard-template-owned shared schemas
              determinism_contract: guard-specs (policy enforcement) + guard-template (implementation)
              bootstrap_artifacts: guard-specs (generation) / object_store (storage)
      - id: MSPEC-006
        title: "Versioning policy"
        tasks:
          - |
            versioning_policy:
              - follow_semver: true
              - breaking_changes_require: major
              - schema_changes_require: minor_or_major (explicit per-schema rule)
              - downstream_pillars_must_pin_template_version: true
              - migration_guides_required_for_major_versions
              - require_changelog_fragment_on_update: true

  # ============================================================
  # PHASE 3 — DATA MODEL & SCHEMAS
  # ============================================================
  - phase: data_model_and_schemas
    summary: "Define canonical records and schema registry expectations."
    items:
      - id: MSPEC-007
        title: "Data model"
        tasks:
          - |
            data_model:
              product_record:
                id: string  # unique, lowercase-dashed
                name: string
                description: string
                maintainers: list[string]
                status: enum(draft, active, deprecated)
                spec_yaml: text
                checklist_yaml: text
                gpt_instructions_yaml: text
                schemas: list[string]
                tags: list[string]
                bootstrap_versions:
                  - version_hash: string
                    timestamp: timestamp
                    artifact_path: string
                latest_bootstrap: string
                validation_report: object
                created_at: timestamp
                updated_at: timestamp
              bootstrap_artifact:
                product_id: string
                version_hash: string
                timestamp: timestamp
                artifact: object
                validation_errors: list[string]
                incomplete: boolean
              feedback_contract:
                product_id: string
                task_id: string
                status: enum(done, blocked, issue, already_done)
                summary: string
                details: object
                timestamp: timestamp
      - id: MSPEC-008
        title: "Schema registry"
        tasks:
          - |
            schemas:
              location: /schemas
              required:
                - product_schema.yml
                - checklist_schema.yml
                - gpt_instructions_schema.yml
                - bootstrap_schema.yml
                - cli_output.json
                - cli_error.json
                - fixpack_schema.yml
              versioning:
                - per-schema semver
                - changes must include compatibility guidance
                - schema PRs require automated backward-compatibility checks

  # ============================================================
  # PHASE 4 — API & CLI SURFACE
  # ============================================================
  - phase: api_and_cli_surface
    summary: "Expose HTTP API, roles, and CLI interface requirements."
    items:
      - id: MSPEC-009
        title: "API endpoints"
        tasks:
          - |
            api:
              base_path: /api/v1
              auth: bearer_token
              roles:
                - reader
                - writer
                - ci
                - admin
              openapi: openapi.yaml
              endpoints:
                - GET  /products
                  desc: list products (paginated)
                  auth: reader
                - POST /products
                  desc: create product (require spec + checklist + gpt-instructions)
                  auth: writer
                  body: { id, spec_yaml, checklist_yaml, gpt_instructions_yaml, maintainers }
                - GET  /products/{id}
                  desc: fetch full product record
                  auth: reader
                - PATCH /products/{id}
                  desc: partial update (replace YAMLs or metadata)
                  auth: writer
                - DELETE /products/{id}
                  desc: deprecate product (status change) — admin confirmation
                  auth: admin
                - POST /products/{id}/validate
                  desc: run schema + master-spec validations
                  auth: ci
                - POST /products/{id}/bootstrap/generate
                  desc: trigger synchronous bootstrap regen; returns metadata
                  auth: ci
                - GET  /products/{id}/bootstrap
                  desc: return latest bootstrap artifact JSON
                  auth: reader
                - POST /products/{id}/audit
                  desc: enqueue audit (used by /ai-dev-report flows)
                  auth: writer
                - POST /webhooks/scan-result
                  desc: receive Implementor #FEEDBACK_CONTRACT and persist/update product state
                  security: webhook_secret
      - id: MSPEC-010
        title: "CLI commands"
        tasks:
          - |
            cli:
              tool: guard-specs-cli
              commands:
                - product:create --id <id> --spec <file> --checklist <file> --instructions <file>
                - product:update --id <id> --patch <file>
                - bootstrap:generate --id <id> [--print]
                - validate --id <id>
                - product:list
              default_output: JSON
              ux_requirements:
                - outputs must be copy-paste friendly for Architect sessions
                - error codes should conform to /schemas/cli_error.json

  # ============================================================
  # PHASE 5 — BOOTSTRAP GENERATION PIPELINE
  # ============================================================
  - phase: bootstrap_generation_pipeline
    summary: "Define artifact shape, algorithm, and determinism guarantees."
    items:
      - id: MSPEC-011
        title: "Bootstrap generation"
        tasks:
          - |
            bootstrap_generation:
              purpose: produce deterministic JSON bootstrap artifact for Architect consumption
              artifact_shape:
                - metadata: { product_id, timestamp, version_hash, generator_version }
                - spec: raw spec_yaml
                - checklist: raw checklist_yaml
                - gpt_instructions: raw gpt_instructions_yaml
                - session_skeleton: { last_checklist_item: null, last_instruction_version: 0 }
                - validation_report: []
              algorithm:
                - load YAMLs
                - validate against schemas
                - compose canonical JSON (canonical key ordering, list sorting rules)
                - normalize environment-dependent fields (paths, runtime metadata)
                - compute version_hash: sha256(canonical_json)[0:12]
                - persist artifact to object_store and metadata DB
                - optionally commit artifact to repo path /bootstraps/<product>.json (configurable)
              determinism_requirements:
                - canonical serialization consistent across platforms
                - normalization: strip_absolute_paths, normalize_path_separators, remove_platform_specific_metadata
                - snapshot test: generate 3x and assert identical version_hash

  # ============================================================
  # PHASE 6 — VALIDATION ENGINE & SCHEDULER
  # ============================================================
  - phase: validation_and_scheduler
    summary: "Describe validation engine outputs and scheduler policies."
    items:
      - id: MSPEC-012
        title: "Validation engine"
        tasks:
          - |
            validation_engine:
              features:
                - schema validation (YAML -> JSON schema)
                - cross-check spec vs checklist consistency
                - no-secrets detection (disallow common secret patterns)
                - checklist completeness: unique IDs, acceptance_criteria presence
                - naming conformance (id format rules)
                - fixpack references verification (if fixpack present)
                - master_spec invariants enforcement (e.g., determinism flags)
              output:
                - structured validation_report with severity, file/line references, remediation hints
              integration_points:
                - API endpoints, CLI, scheduler, bootstrap generator, webhooks
      - id: MSPEC-013
        title: "Scheduler"
        tasks:
          - |
            scheduler:
              responsibilities:
                - periodic artifact regeneration (default PT15M)
                - incremental generation on git push / webhook triggers
                - manage job queue with retries and exponential backoff
              policies:
                - do not replace artifact on validation failure
                - on failure: store artifact as incomplete and notify maintainers
                - admin override allowed for forced regeneration

  # ============================================================
  # PHASE 7 — STORAGE & WEBHOOKS
  # ============================================================
  - phase: storage_and_webhooks
    summary: "Capture storage tiers and webhook ingestion controls."
    items:
      - id: MSPEC-014
        title: "Storage layers"
        tasks:
          - |
            storage:
              metadata_db:
                - Postgres (products, bootstrap_versions, validation_reports, changelog)
              artifact_store:
                - S3-compatible object store for bootstrap JSON artifacts
              backups:
                - daily DB snapshot retention 30 days
                - artifact lifecycle policy: retain 12 months (configurable)
      - id: MSPEC-015
        title: "Webhooks"
        tasks:
          - |
            webhooks:
              endpoints:
                - POST /webhooks/scan-result
                  desc: ingest Implementor #FEEDBACK_CONTRACT
                  security: HMAC signature using webhook_secret
                  on_receive:
                    - validate signature
                    - persist feedback_contract
                    - update product validation state or session_state
                    - optionally trigger automated tasks (e.g., schedule re-validation)
              secret_mana
              secret_management:
                - rotate webhook_secret monthly
                - notify maintainers on rotation

  # ============================================================
  # PHASE 8 — GOVERNANCE, SECURITY & OBSERVABILITY
  # ============================================================
  - phase: governance_security_observability
    summary: "Enforce change management, security, and telemetry controls."
    items:
      - id: MSPEC-016
        title: "Governance"
        tasks:
          - |
            governance:
              change_management:
                - all product updates must include changelog fragment
                - breaking schema changes require RFC + two platform approvers
                - deprecation warnings published at least 3 release cycles prior
              migration_guides:
                - required for any major schema or artifact contract change
                - published under /docs/migrations/<schema>-vX-to-vY.md
              audit_logging:
                - record actor, commit_hash, diff, timestamp for writes
      - id: MSPEC-017
        title: "Security"
        tasks:
          - |
            security:
              auth:
                - bearer token for API with RBAC
                - roles: reader, writer, ci, admin
              input_safety:
                - specs cannot contain literal secrets (validation rule)
                - redact PII in logs and validation reports
              webhook_security:
                - HMAC verification
              supply_chain:
                - dependency vulnerability scanning for guard-specs repo
      - id: MSPEC-018
        title: "Observability"
        tasks:
          - |
            observability:
              metrics:
                - product_count
                - validation_failures_total
                - bootstrap_generation_duration_seconds
                - scheduler_job_success_ratio
                - api_error_rate
              logging:
                - structured JSON logs with request_id, actor, product_id
              tracing:
                - trace bootstrap generation paths
              alerts:
                - validation_failure_spike → paging
                - scheduler_job_failure_rate > threshold → paging

  # ============================================================
  # PHASE 9 — TESTING & CI/CD
  # ============================================================
  - phase: testing_and_ci_cd
    summary: "Maintain comprehensive testing strategy and CI gates."
    items:
      - id: MSPEC-019
        title: "Testing"
        tasks:
          - |
            testing:
              unit_tests:
                - schema validators
                - canonical serializer
                - bootstrap composer
                - auth/role enforcement
              integration_tests:
                - create product → validate → generate → fetch artifact (end-to-end)
                - webhook flow ingestion
              determinism_tests:
                - run bootstrap generation 3x with identical inputs → assert identical hashes
              e2e_tests:
                - simulate Architect session: CLI copy → Architect consumes artifact → Implementor feedback cycle
              test_data:
                - include sample product specs: simple, intermediate, complex
                - include malformed specs for negative tests
      - id: MSPEC-020
        title: "CI/CD"
        tasks:
          - |
            ci_cd:
              pipelines:
                - pre-commit: linters, schema validate (fast)
                - pre-merge: unit + integration + determinism tests
                - release: tag, publish openapi.yaml, run smoke tests (staging)
              releases:
                - semantic versioning
                - changelog fragment required
                - publish release notes and migration guidance for major bumps

  # ============================================================
  # PHASE 10 — DOCUMENTATION & INTEGRATIONS
  # ============================================================
  - phase: documentation_and_integrations
    summary: "Document OpenAPI, developer experience, integration, and deliverables."
    items:
      - id: MSPEC-021
        title: "OpenAPI"
        tasks:
          - |
            openapi:
              file: openapi.yaml
              must_document:
                - endpoints and request/response schemas
                - auth flows and scopes
                - example requests for CLI consumption
      - id: MSPEC-022
        title: "Developer experience"
        tasks:
          - |
            developer_experience:
              docs:
                - getting_started.md (authoring product spec & checklist)
                - schema_guides.md (writing valid schemas)
                - bootstrap_consumer.md (how to consume artifact in Architect)
                - api_reference.md (human readable)
                - migration_guide_template.md
              cli expectations:
                - guard-specs-cli should produce JSON suitable for Architect paste
                - include helpful error messages and remediation hints
      - id: MSPEC-023
        title: "Integration points"
        tasks:
          - |
            integration_points:
              - guard-template: read shared schemas, guidance and bootstrapping patterns
              - guard-repos (concrete pillars): push audits/webhooks and retrieve artifacts
              - CI systems: call /products/{id}/validate pre-merge
              - Architect (browser): GET /products/{id}/bootstrap and paste into session
      - id: MSPEC-024
        title: "Deliverables"
        tasks:
          - |
            deliverables:
              initial:
                - repos/guard-specs/spec.yml
                - repos/guard-specs/checklist.yml
                - /schemas/product_schema.yml
                - /schemas/checklist_schema.yml
                - /schemas/gpt_instructions_schema.yml
                - /schemas/bootstrap_schema.yml
                - /schemas/cli_output.json
                - /schemas/cli_error.json
                - openapi.yaml
                - guard-specs-cli skeleton
                - scheduler job definitions
                - CI workflow manifests
                - docs for authoring, migration, and bootstrap consumption
              ongoing:
                - migration guides on major changes
                - sample specs for canonical pillar types

  # ============================================================
  # PHASE 11 — ACCEPTANCE, INIT, AND RUNBOOKS
  # ============================================================
  - phase: acceptance_and_runbook
    summary: "Capture initialization, acceptance, runbooks, and appendix flows."
    items:
      - id: MSPEC-025
        title: "Initialization requirements"
        tasks:
          - |
            initialization_requirements:
              - "poetry install must succeed without flags"
              - "pytest -q must pass in CI using included test data"
              - "guard-specs-cli --help must succeed"
              - "schema-validation script must validate /schemas directory"
              - "catalog/index.yml (if present) must be valid"
      - id: MSPEC-026
        title: "Acceptance criteria"
        tasks:
          - |
            acceptance_criteria:
              - end_to_end: create product → validate → generate bootstrap → Architect consumes artifact
              - determinism: repeated generation of identical inputs yields identical version_hash (3x)
              - governance: schema change flow and migration guide exist for major bumps
              - security: RBAC enforced for writes; webhooks validated
              - docs: authoring guide and API reference present and verified
      - id: MSPEC-027
        title: "Operational runbook"
        tasks:
          - |
            operational_runbook:
              maintenance_tasks:
                - rotate_webhook_secret: monthly
                - run_schema_compat_check: on schema PR
                - full_bootstrap_regeneration: weekly (configurable)
                - backup_metadata_db: daily
              incident_response:
                - scheduler_failure: page oncall, requeue failed jobs
                - deterministic_test_failure: mark artifact incomplete, notify maintainers
                - validation_failure_spike: open incident and triage
      - id: MSPEC-028
        title: "Appendix"
        tasks:
          - |
            appendix:
              sample_product_flow:
                - "1. user POST /products with spec+checklist+instructions"
                - "2. guard-specs validates and stores product"
                - "3. guard-specs generates bootstrap artifact and persists metadata"
                - "4. Architect fetches artifact and begins session"
                - "5. Implementor runs tasks and may POST #FEEDBACK_CONTRACT to /webhooks/scan-result"
              uploaded_draft_trace: "/mnt/data/guardsuite-specs.yml"

legacy_spec_dump: |-
  # repos/guard-specs/spec.yml
  # GuardSuite — guard-specs Service Specification (authoritative)
  # Purpose: canonical product spec & checklist registry, schema registry,
  # validation engine, deterministic bootstrap generator, and governance control plane.

  metadata:
    id: guard-specs
    name: GuardSpecs
    title: GuardSuite Specs Service
    version: 1.0.0
    owner: GuardSuite Platform Team
    contact: platform@guardsuite.internal
    created: 2025-11-24
    repo_path: repos/guard-specs
    source_draft_reference: "/mnt/data/guardsuite-specs.yml" # session upload (traceability only)

  mission:
    - "Be the canonical source-of-truth for product specs, checklists, and gpt-instructions across GuardSuite."
    - "Produce deterministic, validated, versioned bootstrap artifacts consumable by Architect sessions and tooling."
    - "Enforce schema-first governance, versioning discipline, and lifecycle management across the suite."

  purpose:
    summary: >
      guard-specs stores product YAML specs and checklists, validates them against the schema registry,
      generates deterministic bootstrap artifacts (spec + checklist + gpt-instructions + session skeleton),
      exposes programmatic APIs and CLI for CI/Architect consumption, and manages governance and migrations.

  principles:
    - "Schema-first: all public shapes live under /schemas and are versioned."
    - "Determinism: identical inputs must produce identical bootstrap artifacts."
    - "Governance: breaking changes require migration guides and downstream pinning."
    - "No secrets: specs must not contain secrets; secrets are external references."
    - "Auditability: every change must be recorded with actor, timestamp, and diff."

  scope:
    responsibilities:
      - authoritative storage of product specs, checklists, and gpt-instructions
      - schema registry and schema validation service
      - deterministic bootstrap artifact generation and versioning
      - API and CLI for product lifecycle operations (create, update, validate, generate)
      - scheduler for periodic/regenerative bootstrap generation
      - webhook ingestion for Implementor #FEEDBACK_CONTRACT and CI audit results
      - governance workflows (deprecation, migration, version pinning)
      - artifact storage, metadata DB, and backup
    out_of_scope:
      - runtime execution of pillar code (concrete pillars run their own code)
      - platform network gateway and auth proxy (handled by platform/gateway)
      - secret manager storage for sensitive values (use external secret manager)

  responsibility_matrix:
    canonical_serializer: guardsuite-core (future)
    evaluator_pipeline: guard-template (implementation) / concrete pillars (consumers)
    issue_model: guardsuite-core (future) / dev-shim (template)
    rule_bundles: concrete pillars
    fixpacks: concrete pillars (catalog indexed by guard-specs)
    schemas: guard-specs (registry) + guard-template-owned shared schemas
    determinism_contract: guard-specs (policy enforcement) + guard-template (implementation)
    bootstrap_artifacts: guard-specs (generation) / object_store (storage)

  versioning_policy:
    - follow_semver: true
    - breaking_changes_require: major
    - schema_changes_require: minor_or_major (explicit per-schema rule)
    - downstream_pillars_must_pin_template_version: true
    - migration_guides_required_for_major_versions
    - require_changelog_fragment_on_update: true

  data_model:
    product_record:
      id: string  # unique, lowercase-dashed
      name: string
      description: string
      maintainers: list[string]
      status: enum(draft, active, deprecated)
      spec_yaml: text
      checklist_yaml: text
      gpt_instructions_yaml: text
      schemas: list[string]
      tags: list[string]
      bootstrap_versions:
        - version_hash: string
          timestamp: timestamp
          artifact_path: string
      latest_bootstrap: string
      validation_report: object
      created_at: timestamp
      updated_at: timestamp
    bootstrap_artifact:
      product_id: string
      version_hash: string
      timestamp: timestamp
      artifact: object
      validation_errors: list[string]
      incomplete: boolean
    feedback_contract:
      product_id: string
      task_id: string
      status: enum(done, blocked, issue, already_done)
      summary: string
      details: object
      timestamp: timestamp

  schemas:
    location: /schemas
    required:
      - product_schema.yml
      - checklist_schema.yml
      - gpt_instructions_schema.yml
      - bootstrap_schema.yml
      - cli_output.json
      - cli_error.json
      - fixpack_schema.yml
    versioning:
      - per-schema semver
      - changes must include compatibility guidance
      - schema PRs require automated backward-compatibility checks

  api:
    base_path: /api/v1
    auth: bearer_token
    roles:
      - reader
      - writer
      - ci
      - admin
    openapi: openapi.yaml
    endpoints:
      - GET  /products
        desc: list products (paginated)
        auth: reader
      - POST /products
        desc: create product (require spec + checklist + gpt-instructions)
        auth: writer
        body: { id, spec_yaml, checklist_yaml, gpt_instructions_yaml, maintainers }
      - GET  /products/{id}
        desc: fetch full product record
        auth: reader
      - PATCH /products/{id}
        desc: partial update (replace YAMLs or metadata)
        auth: writer
      - DELETE /products/{id}
        desc: deprecate product (status change) — admin confirmation
        auth: admin
      - POST /products/{id}/validate
        desc: run schema + master-spec validations
        auth: ci
      - POST /products/{id}/bootstrap/generate
        desc: trigger synchronous bootstrap regen; returns metadata
        auth: ci
      - GET  /products/{id}/bootstrap
        desc: return latest bootstrap artifact JSON
        auth: reader
      - POST /products/{id}/audit
        desc: enqueue audit (used by /ai-dev-report flows)
        auth: writer
      - POST /webhooks/scan-result
        desc: receive Implementor #FEEDBACK_CONTRACT and persist/update product state
        security: webhook_secret

  cli:
    tool: guard-specs-cli
    commands:
      - product:create --id <id> --spec <file> --checklist <file> --instructions <file>
      - product:update --id <id> --patch <file>
      - bootstrap:generate --id <id> [--print]
      - validate --id <id>
      - product:list
    default_output: JSON
    ux_requirements:
      - outputs must be copy-paste friendly for Architect sessions
      - error codes should conform to /schemas/cli_error.json

  bootstrap_generation:
    purpose: produce deterministic JSON bootstrap artifact for Architect consumption
    artifact_shape:
      - metadata: { product_id, timestamp, version_hash, generator_version }
      - spec: raw spec_yaml
      - checklist: raw checklist_yaml
      - gpt_instructions: raw gpt_instructions_yaml
      - session_skeleton: { last_checklist_item: null, last_instruction_version: 0 }
      - validation_report: []
    algorithm:
      - load YAMLs
      - validate against schemas
      - compose canonical JSON (canonical key ordering, list sorting rules)
      - normalize environment-dependent fields (paths, runtime metadata)
      - compute version_hash: sha256(canonical_json)[0:12]
      - persist artifact to object_store and metadata DB
      - (optionally) commit artifact to repo path /bootstraps/<product>.json (configurable)
    determinism_requirements:
      - canonical serialization consistent across platforms
      - normalization: strip_absolute_paths, normalize_path_separators, remove_platform_specific_metadata
      - snapshot test: generate 3x and assert identical version_hash

  validation_engine:
    features:
      - schema validation (YAML -> JSON schema)
      - cross-check spec vs checklist consistency
      - no-secrets detection (disallow common secret patterns)
      - checklist completeness: unique IDs, acceptance_criteria presence
      - naming conformance (id format rules)
      - fixpack references verification (if fixpack present)
      - master_spec invariants enforcement (e.g., determinism flags)
    output:
      - structured validation_report with severity, file/line references, remediation hints
    integration_points:
      - API endpoints, CLI, scheduler, bootstrap generator, webhooks

  scheduler:
    responsibilities:
      - periodic artifact regeneration (default PT15M)
      - incremental generation on git push / webhook triggers
      - manage job queue with retries and exponential backoff
    policies:
      - do not replace artifact on validation failure
      - on failure: store artifact as incomplete and notify maintainers
      - admin override allowed for forced regeneration

  storage:
    metadata_db:
      - Postgres (products, bootstrap_versions, validation_reports, changelog)
    artifact_store:
      - S3-compatible object store for bootstrap JSON artifacts
    backups:
      - daily DB snapshot retention 30 days
      - artifact lifecycle policy: retain 12 months (configurable)

  webhooks:
    endpoints:
      - POST /webhooks/scan-result
        desc: ingest Implementor #FEEDBACK_CONTRACT
        security: HMAC signature using webhook_secret
        on_receive:
          - validate signature
          - persist feedback_contract
          - update product validation state or session_state
          - optionally trigger automated tasks (e.g., schedule re-validation)
    secret_management:
      - rotate webhook_secret monthly
      - notify maintainers on rotation

  governance:
    change_management:
      - all product updates must include changelog fragment
      - breaking schema changes require RFC + two platform approvers
      - deprecation warnings published at least 3 release cycles prior
    migration_guides:
      - required for any major schema or artifact contract change
      - published under /docs/migrations/<schema>-vX-to-vY.md
    audit_logging:
      - record actor, commit_hash, diff, timestamp for writes

  security:
    auth:
      - bearer token for API with RBAC
      - roles: reader, writer, ci, admin
    input_safety:
      - specs cannot contain literal secrets (validation rule)
      - redact PII in logs and validation reports
    webhook_security:
      - HMAC verification
    supply_chain:
      - dependency vulnerability scanning for guard-specs repo

  observability:
    metrics:
      - product_count
      - validation_failures_total
      - bootstrap_generation_duration_seconds
      - scheduler_job_success_ratio
      - api_error_rate
    logging:
      - structured JSON logs with request_id, actor, product_id
    tracing:
      - trace bootstrap generation paths
    alerts:
      - validation_failure_spike → paging
      - scheduler_job_failure_rate > threshold → paging

  testing:
    unit_tests:
      - schema validators
      - canonical serializer
      - bootstrap composer
      - auth/role enforcement
    integration_tests:
      - create product → validate → generate → fetch artifact (end-to-end)
      - webhook flow ingestion
    determinism_tests:
      - run bootstrap generation 3x with identical inputs → assert identical hashes
    e2e_tests:
      - simulate Architect session: CLI copy → Architect consumes artifact → Implementor feedback cycle
    test_data:
      - include sample product specs: simple, intermediate, complex
      - include malformed specs for negative tests

  ci_cd:
    pipelines:
      - pre-commit: linters, schema validate (fast)
      - pre-merge: unit + integration + determinism tests
      - release: tag, publish openapi.yaml, run smoke tests (staging)
    releases:
      - semantic versioning
      - changelog fragment required
      - publish release notes and migration guidance for major bumps

  openapi:
    file: openapi.yaml
    must_document:
      - endpoints and request/response schemas
      - auth flows and scopes
      - example requests for CLI consumption

  developer_experience:
    docs:
      - getting_started.md (authoring product spec & checklist)
      - schema_guides.md (writing valid schemas)
      - bootstrap_consumer.md (how to consume artifact in Architect)
      - api_reference.md (human readable)
      - migration_guide_template.md
    cli:
      - guard-specs-cli should produce JSON suitable for Architect paste
      - include helpful error messages and remediation hints

  integration_points:
    - guard-template: read shared schemas, guidance and bootstrapping patterns
    - guard-repos (concrete pillars): push audits/webhooks and retrieve artifacts
    - CI systems: call /products/{id}/validate pre-merge
    - Architect (browser): GET /products/{id}/bootstrap and paste into session

  deliverables:
    initial:
      - repos/guard-specs/spec.yml
      - repos/guard-specs/checklist.yml
      - /schemas/product_schema.yml
      - /schemas/checklist_schema.yml
      - /schemas/gpt_instructions_schema.yml
      - /schemas/bootstrap_schema.yml
      - /schemas/cli_output.json
      - /schemas/cli_error.json
      - openapi.yaml
      - guard-specs-cli skeleton
      - scheduler job definitions
      - CI workflow manifests
      - docs for authoring, migration, and bootstrap consumption
    ongoing:
      - migration guides on major changes
      - sample specs for canonical pillar types

  initialization_requirements:
    - "poetry install must succeed without flags"
    - "pytest -q must pass in CI using included test data"
    - "guard-specs-cli --help must succeed"
    - "schema-validation script must validate /schemas directory"
    - "catalog/index.yml (if present) must be valid"

  acceptance_criteria:
    - end_to_end: create product → validate → generate bootstrap → Architect consumes artifact
    - determinism: repeated generation of identical inputs yields identical version_hash (3x)
    - governance: schema change flow and migration guide exist for major bumps
    - security: RBAC enforced for writes; webhooks validated
    - docs: authoring guide and API reference present and verified

  operational_runbook:
    maintenance_tasks:
      - rotate_webhook_secret: monthly
      - run_schema_compat_check: on schema PR
      - full_bootstrap_regeneration: weekly (configurable)
      - backup_metadata_db: daily
    incident_response:
      - scheduler_failure: page oncall, requeue failed jobs
      - deterministic_test_failure: mark artifact incomplete, notify maintainers
      - validation_failure_spike: open incident and triage

  appendix:
    sample_product_flow:
      - "1. user POST /products with spec+checklist+instructions"
      - "2. guard-specs validates and stores product"
      - "3. guard-specs generates bootstrap artifact and persists metadata"
      - "4. Architect fetches artifact and begins session"
      - "5. Implementor runs tasks and may POST #FEEDBACK_CONTRACT to /webhooks/scan-result"
    uploaded_draft_trace: "/mnt/data/guardsuite-specs.yml" # preserved for session traceability

  # End of guard-specs/spec.yml
