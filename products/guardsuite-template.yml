# repos/guardsuite-template/spec.yml
# GuardSuite Template - Authoritative Pillar Bootstrap Specification
# Version: 2025.12.1
# Status: Production

metadata:
  id: guardsuite-template
  name: GuardSuite Template
  product_type: pillar_template
  owner: GuardSuite Platform Team
  spec_version: "2.1.0"
  runtime_api_version: "2025.12"
  schema_version: "2.1.0"
  min_pillar_runtime: "2025.12"
  created: "2025-12-01"
  updated: "2025-12-XX"
  summary: "Authoritative template for creating GuardSuite pillars: deterministic, WASM-safe, binary-backed core utilities, standardized lifecycle, and cross-repo integration."

mission:
  - "Provide a complete, deterministic, WASM-safe baseline for building GuardSuite pillars."
  - "Guarantee contract compliance, cross-pillar consistency, and governance alignment."
  - "Enable rapid creation of new products with minimal drift."

principles:
  - "Schema-first: pillars extend shared fragments aligned with guardsuite-specs."
  - "Deterministic: identical inputs â†’ identical outputs across OS/arch/runtime."
  - "Security-first: sandboxable, reproducible, binary-backed core logic in production."
  - "Governance-aligned: versioned, lifecycle-controlled, with strict contracts."
  - "Modular extensibility: clear boundaries between template/core/pillar."

# ============================================================
# RESPONSIBILITY BOUNDARY
# ============================================================
responsibility_boundary:
  provided_by_template:
    - evaluator_pipeline definition and lifecycle_state_machine
    - CLI verbs, flags, and output structures
    - rule registry, rule scaffolder, and rule scaffolding inputs
    - fixpack loader + validation patterns
    - schema fragments and fragment governance
    - canonicalization & determinism rules (policy-level)
    - telemetry hook definitions and telemetry schema
    - verify & self-test command definitions and expected artifacts
    - scaffolding scripts (scaffold_new_pillar.py)
  provided_by_core:
    - IP-protected binary modules (ABI-stable)
    - canonicalization_core.so
    - evaluator_primitives.so
    - severity_mapping_core.so
    - schema_verifier_core.so
    - fixpack_loader_core.so
  provided_by_pillar:
    - pillar-specific rules and rule bundles
    - pillar-specific schema extensions (under schemas/pillar/)
    - pillar-specific fixpacks and metadata
    - pillar documentation and governance metadata
  forbidden_overrides:
    - evaluator_pipeline
    - canonicalization core behavior
    - severity mapping algorithms provided by core
    - CLI core verbs and output contract
    - schema fragment canonical fields
    - binary core module behavior/ABI

# ============================================================
# VERSIONING & COMPATIBILITY
# ============================================================
versioning_policy:
  semver: true
  breaking_changes_require: major
  binary_abi_compatibility_window: "12 months"
  downstream_migration_required: true
  rfc_required_for:
    - evaluator stage changes
    - canonical output schema modifications
    - severity mapping changes
  template_evolution:
    - spec_version bump requires pillar regeneration guidance

versions:
  spec_version: "2.1.0"
  runtime_api: "2025.12"
  schema_version: "2.1.0"
  min_pillar_runtime: "2025.12"

binary_abi_matrix:
  supported_abi_versions:
    - v1
  supported_cpu_arch:
    - x86_64
    - arm64
  wasm_abi_expected: "wasi_snapshot_preview1"
  compatibility_rules:
    - "Binaries published with ABI v1 are compatible across supported_cpu_arch for 12 months."
    - "ABI changes require major version and migration instructions."

# ============================================================
# EVALUATOR PIPELINE (AUTHORITATIVE)
# ============================================================
evaluator_pipeline:
  stages:
    - load_input
    - initialize_context
    - load_schema
    - validate_schema
    - discover_resources
    - run_rules
    - aggregate_severity
    - fixpack_integration
    - canonicalize_output
    - strict_mode_verify
    - snapshot_normalize
    - emit_output
  invariants:
    - "Stages execute in listed order; skipping a stage must be explicit and logged."
    - "Stages must be idempotent and deterministic."
    - "No stage may perform nondeterministic IO or unbounded parallelism without guardrails."
    - "All timestamps must be UTC ISO-8601."

lifecycle_state_machine:
  states: [INIT, LOADED, VALIDATED, EVALUATED, CANONICALIZED, VERIFIED, EMITTED]
  transitions:
    - "INIT -> LOADED : load_input"
    - "LOADED -> VALIDATED : validate_schema"
    - "VALIDATED -> EVALUATED : run_rules and aggregate"
    - "EVALUATED -> CANONICALIZED : canonicalize_output"
    - "CANONICALIZED -> VERIFIED : strict_mode_verify"
    - "VERIFIED -> EMITTED : emit_output"

# ============================================================
# DETERMINISM CONTRACT
# ============================================================
determinism:
  path_normalization: "strip absolute paths; separator = '/'; lowercase where appropriate"
  float_rules:
    precision: "fixed_64"
    rounding_mode: "round_half_away_from_zero"
    overflow_behavior: "clamp_to_max"
  canonical_ordering:
    - rule_id
    - resource_id
    - severity
    - timestamp_utc
  hash_contract:
    algorithm: "SHA256"
    serialization: "canonical_json_utf8"
    include_fields:
      - rule_id
      - severity
      - metadata
      - canonical_timestamp
    exclude_fields:
      - local_paths
      - transient_debug_fields
  snapshot_requirements:
    runs: 3
    cross_platform: [ubuntu, debian, macos]
    identical_hash_required: true

# ============================================================
# SCHEMA SOURCES & FRAGMENTS
# ============================================================
schema_sources:
  canonical_repo: guardsuite-specs
  fragments_dir: schemas/core
  pillar_extensions_dir: schemas/pillar
  inheritance_rules:
    - "Pillars extend core fragments; do not redefine canonical fields."
  validation_command: "guardtemplate verify"

schemas:
  fragments:
    - schemas/core/common_issue_fragment.json
    - schemas/core/common_metadata_fragment.json
    - schemas/core/common_output_fragment.json
  governance:
    fragment_governance:
      propose_via: RFC
      approval: core_owners + platform_team
      versioning: semver
      migration_policy: "pillar_regeneration_required_on_major"

# ============================================================
# OUTPUT CONTRACT (CANONICAL)
# ============================================================
output_contract:
  schema: schemas/output/canonical_output.json
  invariants:
    - deterministic_key_ordering: true
    - timestamps: "UTC ISO-8601"
    - standardized_error_payloads: true
    - severity_buckets_enforced: [critical, high, medium, low, info]
    - fixpack_fields_normalized: true
    - provenance_required: true

# ============================================================
# BOOTSTRAP OUTPUTS
# ============================================================
bootstrap_outputs:
  - evaluator_pipeline_manifest.json
  - rule_registry_index.json
  - fixpack_catalog_index.json
  - cli_flag_manifest.json
  - snapshot_fixture_templates/

# ============================================================
# TELEMETRY (UNIFIED + LIMITS)
# ============================================================
telemetry:
  hooks:
    - evaluator_start
    - evaluator_end
    - rule_fired
    - fixpack_loaded
    - plan_loaded
  schema:
    - event_type: string
    - timestamp_utc: string
    - rule_id: string?
    - pillar_id: string
    - severity: string?
    - duration_ms: integer?
    - metadata: object?
  limits:
    max_event_payload_bytes: 64_000
    max_events_per_rule_execution: 10
    redact_patterns:
      - ".*secret.*"
      - ".*token.*"
    invariants:
      - "Events must be JSON and conform to telemetry.schema."
      - "Redact sensitive fields before emission."
      - "Stable key ordering required for ingestion correctness."

# ============================================================
# BINARY CORE UTILITIES (IP-PROTECTED)
# ============================================================
binary_core:
  modules:
    - canonicalization_core.so
    - evaluator_primitives.so
    - severity_mapping_core.so
    - schema_verifier_core.so
    - fixpack_loader_core.so
  fallback_behavior:
    dev: python_fallback_allowed
    ci: python_fallback_warn
    production: python_fallback_forbidden
  abi_matrix_reference: binary_abi_matrix

# ============================================================
# RULE SYSTEM & SCAFFOLDING
# ============================================================
rule_system:
  rule_scaffolder:
    command: "pillar.rules scaffold <rule-id>"
    inputs_collected:
      - severity (required)
      - remediation_hint (optional)
      - fixpack_hint (optional)
      - categories/tags
    generates:
      - rule_source_file
      - rule_metadata_block
      - rule_schema_fragment
      - unit_test_skeleton
      - snapshot_fixture
      - optional_fixpack_stub
  rule_fixpack_alignment:
    fixpacks_must_reference_valid_rule_ids: true
    rule_bundles_must_emit_all_severities: [critical, high, medium, low]
    snapshots_must_include_at_least: 4 severities

# ============================================================
# SEVERITY MAPPING UTILITIES
# ============================================================
severity_mapping:
  module: severity_mapping_core.so
  buckets: [critical, high, medium, low, info]
  invariants:
    - deterministic_weighting: true
    - wasm_safe_integers_only: true
    - no_bucket_redefinition_by_pillars: true

# ============================================================
# FIXPACK INTEGRATION
# ============================================================
fixpacks:
  required_metadata:
    - fixpack_id
    - description
    - remediation_snippet
    - difficulty
    - impacted_resources
  validation:
    - schema_valid
    - rule_id_consistency
    - snippet_normalization
  determinism:
    - previews_normalized: true
    - patch_hashing_required: true

# ============================================================
# ADAPTER & RESOURCE DISCOVERY
# ============================================================
adapter_boundary:
  description: "Template defines interfaces; pillars implement provider logic."
  interfaces:
    - discover()
    - fetch_metadata()
    - capability_manifest()
  adapter_compatibility:
    - "Adapters must conform to adapter interface and capability manifest."
    - "Adapters must not perform nondeterministic I/O during canonicalization."

resource_discovery:
  resource_definition:
    - resource_id: string (unique)
    - resource_type: string
    - provider: string
    - discovered_at: timestamp_utc
  required_identifiers:
    - resource_id
    - provider_id (if applicable)
  invariants:
    - discovery must be idempotent
    - resource identifiers canonicalized
    - capability_manifest must be provided by each adapter

# ============================================================
# MULTITENANCY
# ============================================================
multitenancy:
  enabled: false
  required_field_if_enabled: tenant_id
  normalization: lowercase
  invariants:
    - "No tenant bleed-through."
    - "All artifacts must match scoring/processing tenant_id if enabled."

# ============================================================
# CONFIGURATION & PILLAR INTEROP
# ============================================================
configuration:
  file: pillar_config.yml
  supports:
    - severity_overrides
    - rule_enablement
    - fixpack_enablement
    - evaluation_modes
  invariants:
    - config must validate against template config schema
    - config may not override forbidden template fields

pillar_interop:
  policy:
    - "Pillars SHOULD NOT directly depend on another pillar's internal artifacts."
    - "Inter-pillar integration allowed only via canonical artifacts published to guardsuite-specs."
    - "Cross-pillar references must be explicit and version-pinned."

# ============================================================
# FRONT-END DETERMINISM
# ============================================================
frontend_determinism:
  pinned_node_version: required
  lockfile_required: true
  no_randomized_build_artifacts: true
  normalize_ssr_output: true
  invariants:
    - "UI builds used in CI must produce deterministic SSR payloads for snapshot tests."

# ============================================================
# CLI CONTRACT
# ============================================================
cli:
  verbs: [scan, explain, validate, rules, verify, validate-self]
  flags:
    - --json
    - --stdin
    - --quiet
    - --strict
    - --profile <name>
    - --out <path>
  exit_codes:
    VALIDATION_ERROR: 2
    RUNTIME_ERROR: 3
    SCHEMA_ERROR: 4
    STRICT_MODE_FAILURE: 5
  invariants:
    - help output must be machine-parseable
    - --json must validate against CLI JSON schema

# ============================================================
# SELF-TEST & VERIFY
# ============================================================
self_test:
  command: "pillar validate-self"
  artifacts:
    - selftest-report.json
    - canonical-output-preview.json
  exit_codes:
    PASS: 0
    FAIL: 1

verify:
  command: "guardtemplate verify"
  produces:
    - verify-report.json
  checks:
    - schema_presence
    - schema_validity
    - fixpack_consistency
    - rule_registry_integrity
    - wasm_safety
    - evaluator_alignment

# ============================================================
# CI CONTRACT
# ============================================================
ci_contract:
  required_jobs:
    - validate_schema
    - unit
    - integration
    - snapshot
    - wasm
    - self_test
    - verify
  invariants:
    - verify must pass before merge
    - self_test must pass in CI
    - snapshot determinism enforced across CI images

# ============================================================
# CROSS-REPO INTEGRATION
# ============================================================
cross_repo_integration:
  requires:
    - guardsuite-specs version >= schema_version
    - guardsuite-core runtime >= min_pillar_runtime
  artifacts_exchanged:
    - schema fragments
    - binary_core ABI manifests
    - bootstrap outputs

# ============================================================
# PILLAR SCAFFOLDING
# ============================================================
scaffolding:
  script: scaffold_new_pillar.py
  generates:
    - spec.yml (fully populated)
    - checklist.yml stub
    - schemas/ (core fragments + pillar extensions)
    - rules/ directory with example rule
    - fixpack/ directory with stub
    - cli entrypoint
    - web/ skeleton
    - docs/ skeleton
    - migrations/ directory
  guarantees:
    - deterministic initial structure
    - governance metadata included

pillar_minimum_files:
  - spec.yml
  - checklist.yml
  - schemas/
  - fixpack/
  - rules/
  - cli entrypoint
  - migrations/

# ============================================================
# PERFORMANCE CONTRACT
# ============================================================
performance_contract:
  budgets:
    - max_rule_execution_ms: 50
    - max_fixpack_load_ms: 200
    - max_evaluator_latency_ms: 300
  perf_tests:
    - representative_dataset: tests/data/perf/representative
    - regression_threshold_percent: 5
  invariants:
    - performance budgets must be validated in CI

# ============================================================
# RESOURCE & SECURITY
# ============================================================
security:
  wasm_requirements:
    - no_dynamic_imports
    - deterministic_io_only
    - no_network_egress_in_preview
  governance:
    - codeowners_required: true
    - security_review_required: true
    - license_compliance_required: true
    - changelog_per_release_required: true

# ============================================================
# ACCEPTANCE CRITERIA
# ============================================================
acceptance_criteria:
  - "Pillars created via template pass verify + self-test."
  - "Canonically formatted output conforms to output_contract."
  - "Telemetry hooks implemented and within telemetry.limits."
  - "Binary-backed modules used for production builds; fallback rules applied."
  - "CI contract satisfied before release."
  - "Cross-repo compatibility checks passed."

# ============================================================
# DELIVERABLES
# ============================================================
deliverables:
  - spec.yml (this file)
  - scaffold_new_pillar.py
  - guardtemplate CLI with verify/self-test commands
  - canonical schema fragments under schemas/core/
  - rule_scaffolder utility
  - binary core module ABI manifests
  - sample pillar generated by scaffold (example_pillar/)
