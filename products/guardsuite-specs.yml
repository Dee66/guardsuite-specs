# repos/guard-specs/spec.yml
# GuardSuite - guard-specs repository specification
# Purpose: single source of truth and API for product specs, checklists, and architect bootstraps.

metadata:
  id: guard-specs
  title: GuardSuite Specs Service
  version: 1.0.0
  author: GuardSuite Platform Team
  created: 2025-11-23
  contact: platform@guardsuite.internal
  license: internal-proprietary

purpose:
  summary: >
    guard-specs stores canonical product specifications and implementation checklists,
    produces "architect bootstrap" artifacts (spec + checklist + gpt-instructions),
    and exposes an authenticated API for consumption and update by products,
    CI pipelines, and operators. It is the authoritative source-of-truth for
    GuardSuite product metadata and bootstraps used to initialize Architect sessions.
  alignment: "Follows global GuardSuite Master Spec principles for determinism, schema-first, and safe automation." # See master spec. :contentReference[oaicite:1]{index=1}

data_model:
  product:
    required:
      - id
      - name
      - owner
      - version
      - spec_yaml     # full product spec (YAML string / stored blob)
      - checklist_yaml
      - gpt_instructions_yaml
    optional:
      - status        # draft | active | deprecated
      - tags
      - last_updated
      - bootstrap_version   # hash of spec+checklist+instructions
      - validation_errors
  checklist_item:
    fields:
      - id
      - title
      - description
      - estimate
      - acceptance_criteria
      - status         # todo|in_progress|done|blocked
      - owner
  bootstrap_artifact:
    fields:
      - product_id
      - timestamp
      - bootstrap_json  # generated JSON with spec/checklist/gpt-instructions/session_state skeleton
      - version_hash
      - incomplete (boolean)
      - validation_errors

api:
  base_path: /api/v1
  auth: token_bearer  # see security section
  endpoints:
    - path: /products
      method: GET
      description: "List products and high level metadata (paginated)."
      response: 200: { products: [{id,name,version,status}] }
    - path: /products
      method: POST
      description: "Create new product entry (spec+checklist+gpt_instructions)."
      request: 201: { id, spec_yaml:string, checklist_yaml:string, gpt_instructions_yaml:string }
      auth_required: platform_write
    - path: /products/{id}
      method: GET
      description: "Fetch full product record (metadata + spec + checklist + instructions)."
      response: 200: { product }
      auth_required: platform_read
    - path: /products/{id}
      method: PATCH
      description: "Update product metadata or replace spec/checklist/instructions (partial update)."
      request: { spec_yaml?, checklist_yaml?, gpt_instructions_yaml?, status? }
      response: 200
      auth_required: platform_write
    - path: /products/{id}/bootstrap
      method: GET
      description: "Return the latest bootstrap artifact JSON for Architect consumption. Intended to be copy/pasted into Architect session or fetched by Implementor (Copilot) in VSCode."
      query_params:
        - include_session_state (bool, default false)
      response: 200: { bootstrap_json }
      auth_required: platform_read
    - path: /products/{id}/bootstrap/generate
      method: POST
      description: "Trigger re-generation of bootstrap artifact from current spec+checklist+gpt_instructions. Returns artifact metadata."
      response: 200: { product_id, version_hash, timestamp }
      auth_required: platform_ci
    - path: /products/{id}/validate
      method: POST
      description: "Run server-side validation (schema + master rules) and return validation report."
      response: 200: { valid:boolean, validation_errors: [] }
      auth_required: platform_ci
    - path: /products/{id}/audit
      method: POST
      description: "Trigger an audit task that instructs Implementor to run a repository audit; returns a task id."
      request: { scope: all | repo | path, options: {} }
      response: 202: { task_id }
      auth_required: platform_write
    - path: /webhooks/scan-result
      method: POST
      description: "Receive scan/audit results from Implementor or CI (used to update product state)."
      security: webhook_secret
      request: { product_id, task_id, feedback_contract: string, summary: object }
      response: 200

bootstrap_generation:
  algorithm:
    - load product.spec_yaml and product.checklist_yaml and product.gpt_instructions_yaml
    - validate each YAML against product schema
    - compose bootstrap object:
        product: id
        timestamp: utc_iso
        version: short_hash (sha256(spec+checklist+instructions)[0:8])
        spec: raw spec_yaml (string)
        checklist: raw checklist_yaml (string)
        gpt_instructions: raw gpt_instructions_yaml (string)
        architect_session_state: { last_checklist_item: null, last_instruction_version: 0, last_implementor_status: null }
        incomplete: false|true
        validation_errors: []
    - run master-spec checks (determinism / required fields) and append validation_errors
    - write to artifact store and return artifact metadata
  storage:
    - persistent store: db blob or object storage (e.g., S3)
    - optional commit to repo path: /bootstrap/<product_id>.bootstrap.json (committed on change)

validation:
  schema_validator:
    - required: use canonical YAML schemas located in /schemas/product_schema.yml and /schemas/checklist_schema.yml
    - behavior: fail if YAML invalid or required keys missing
  master_spec_checks:
    - "Apply rules from GuardSuite Master Spec for severity mapping, fixpack parity, and deterministic inputs." # :contentReference[oaicite:2]{index=2}
  CI_integration:
    - "Expose `validate` endpoint for CI to check before merge"
    - "Failures produce validation report in product.validation_errors"

cli:
  name: guard-specs-cli
  commands:
    - name: bootstrap:generate
      usage: guard-specs-cli bootstrap generate --product <id> [--print]
      behavior: "Generate bootstrap artifact and either print JSON (for Architect paste) or write to filesystem."
    - name: product:create
      usage: guard-specs-cli product create --id <id> --spec spec.yml --checklist checklist.yml --instructions gpt.yml
    - name: product:validate
      usage: guard-specs-cli product validate --id <id>
    - name: product:list
      usage: guard-specs-cli product list
  output: JSON by default to facilitate copy/paste into Architect sessions

scheduler:
  periodic_generation:
    default_interval: "PT15M" # ISO8601: 15 minutes
    behavior: "Regenerate bootstraps for all products that have both spec & checklist; commit artifacts if changed."
  triggers:
    - on_push_to_main: regenerate affected product bootstraps
    - on_manual_trigger: via /products/{id}/bootstrap/generate

webhook_model:
  purpose: "Allow products and CI/Implementor to push audit & status updates back to guard-specs"
  examples:
    - on_audit_complete: POST /webhooks/scan-result with {product_id, feedback_contract}
    - on_repo_state_change: POST /webhooks/scan-result with {product_id, summary}

security:
  auth:
    methods:
      - bearer_token (short-lived tokens via platform auth service)
      - mTLS for internal services
      - webhook_secret for incoming webhooks
  roles:
    - platform_read: read-only bootstrap & product metadata
    - platform_write: create/update product spec, trigger bootstrap generation
    - platform_ci: CI-triggered endpoints (validate, generate)
    - admin: full access
  secrets_handling:
    - "Never store secrets in spec YAML. Use placeholders only and flag via validation if secrets are found."
  auditing:
    - "All writes must be logged with actor, timestamp, and request payload hash."

observability:
  telemetry:
    - metrics: request_counts, error_rates, bootstrap_generation_time, validation_failures
    - traces: trace bootstrap jobs and API calls
    - logs: structured JSON logs (level, timestamp, request_id)
  alerting:
    - "Alert on sustained validation failures (>5 consecutive runs) or scheduler failures."
  audit_records:
    - "Persist change history for specs and bootstraps (who changed what and when)."

testing:
  unit_tests:
    - "Validator tests for sample good and bad spec YAMLs"
    - "Bootstrap generator unit tests"
  integration_tests:
    - "End-to-end: product create → validate → bootstrap generate → artifact correctness"
    - "Webhook receiver tests"
  e2e:
    - "Simulated Architect flow: CLI generate output -> paste into a sandbox Architect session (test harness)"

deployment:
  container:
    image: guardsuite/guard-specs:latest
    runtime: k8s (recommended)
    resources:
      cpu: 500m
      memory: 512Mi
  infra:
    - "Kubernetes deployment with Horizontal Pod Autoscaler"
    - "Object storage for bootstrap artifacts"
    - "Relational DB for metadata (Postgres)"
  secrets:
    - "Platform auth credentials - stored in K8s secrets"
  upgrades:
    - "Follow canary deployment pattern; run validation smoke tests post-deploy"

governance & lifecycle:
  versioning:
    - "Schema-major changes require bumping spec.yml schema version and notifying downstream repositories"
  changelog:
    - "Each product must include a changelog fragment in its metadata when spec/checklist changes"
  retention:
    - "Keep last 12 months of bootstrap artifacts; archive older artifacts"

integration_points:
  - "CI pipelines (pre-merge validation)"
  - "Implementor (VSCode Copilot) via CLI or API"
  - "Dashboarding/observability to display product status"
  - "Automated sync scripts to copy generated docs into product repos upon human sign-off"

compatibility & migration:
  notes:
    - "Older product files may exist; include migration scripts in /scripts/migrate_old_specs.py"
    - "Tooling will accept both inline YAML and file references; prefer inline YAML for reproducibility."

examples:
  example_request_create:
    method: POST
    path: /api/v1/products
    body:
      id: policy-engine
      spec_yaml: "product: policy-engine\nversion: 0.1.0\nmodules: []"
      checklist_yaml: "- id: PE-001\n  title: scaffold\n  acceptance_criteria: []"
      gpt_instructions_yaml: "context: | ...\ninstruction_schema: {}"
  example_bootstrap_response:
    200:
      bootstrap_json:
        product: policy-engine
        timestamp: "2025-11-23T12:00:00Z"
        version: "a1b2c3d4"
        spec: "<raw spec YAML>"
        checklist: "<raw checklist YAML>"
        gpt_instructions: "<raw gpt-instructions YAML>"
        architect_session_state:
          last_checklist_item: null
          last_instruction_version: 0
          last_implementor_status: null
        incomplete: false
        validation_errors: []

operational_guidance:
  - "Prefer schema-first edits; run validation locally before push."
  - "Guard-specs is the canonical source-of-truth; other systems should consume via API or scheduled sync."
  - "Use the CLI to produce Architect-ready bootstrap JSON for quick manual paste."

appendix:
  master_spec_reference: "GuardSuite Master Spec V1.1. Use it for global rules and invariants." 
  master_spec_citation: ":contentReference[oaicite:3]{index=3}"

