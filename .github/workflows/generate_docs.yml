name: Generate Docs

on:
  push:
    paths:
      - 'products/**'
      - 'templates/**'
      - 'snippets/**'

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      products: ${{ steps.detect.outputs.matrix }}
      count: ${{ steps.detect.outputs.count }}
    steps:
      - uses: actions/checkout@v4
      - name: Detect changed product specs
        id: detect
        env:
          BEFORE: ${{ github.event.before }}
          AFTER: ${{ github.sha }}
        run: |
          set -euo pipefail
          python <<'PY'
          import json
          import os
          import subprocess
          from pathlib import Path

          before = os.environ.get('BEFORE') or '0'*40
          after = os.environ['AFTER']
          if before == '0' * 40:
            cmd = ['git', 'ls-files', 'products']
          else:
            cmd = ['git', 'diff', '--name-only', before, after, '--', 'products/']
          result = subprocess.run(cmd, capture_output=True, text=True, check=True)
          products = []
          for line in result.stdout.splitlines():
            path = Path(line.strip())
            if path.suffix != '.yml':
              continue
            if path.name.endswith('_worksheet.yml'):
              continue
            products.append(path.stem)
          products = sorted(set(products))
          output = os.environ['GITHUB_OUTPUT']
          with open(output, 'a', encoding='utf-8') as handle:
            handle.write(f"matrix={json.dumps(products)}\n")
            handle.write(f"count={len(products)}\n")
          PY

  quality:
    needs: detect
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install poetry
          poetry install --with dev
      - name: Ruff Lint
        run: poetry run ruff check .
      - name: Black Check
        run: poetry run black --check .
      - name: Validate product specs
        run: poetry run python scripts/validate_products.py
      - name: Validate product schema
        run: poetry run python scripts/validate_yaml_schema.py
      - name: Run YAML schema tests
        run: poetry run pytest -q

  render:
    needs: [detect, quality]
    if: needs.detect.outputs.products != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        product: ${{ fromJson(needs.detect.outputs.products) }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install poetry
          poetry install --with dev
      - name: Generate docs
        run: poetry run python scripts/gen_docs.py --product ${{ matrix.product }}
      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.product }}
          path: docs/products/${{ matrix.product }}.md
