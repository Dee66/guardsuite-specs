# COPILOT: This workflow MUST NOT auto-push branches nor open PRs without manual approval.
name: Open Sync PR (manual / gated)

on:
  workflow_dispatch:
    inputs:
      approve_pr:
        type: boolean
        default: false
        description: "Set true only after manual review to enable PR automation placeholders."

jobs:
  open-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install poetry
          poetry install --with dev
      - name: Ruff Lint
        run: poetry run ruff check .
      - name: Run tests
        run: poetry run pytest -q
      - name: Generate docs
        run: poetry run python scripts/gen_docs.py --all
      - name: Prepare sync (local dry-run)
        run: python scripts/sync_to_repo.py --product vectorscan --target ../vectorscan --dry-run
      - name: Summarize doc diff
        id: diff
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            const summary = execSync('git status --short docs', { encoding: 'utf8' }).trim() || 'No doc changes detected.';
            core.info(summary);
            core.setOutput('summary', summary);
      - name: Manual approval gate
        if: inputs.approve_pr != 'true'
        run: |
          echo "Manual approval required before enabling any PR automation." && exit 0
      - name: Placeholder for PR automation
        if: inputs.approve_pr == 'true'
        run: |
          echo "Manual approval received. Implement secure PR creation logic before enabling this step." && exit 1
      # NOTE: For security, do not auto-push or auto-open PRs from this repo without a least-privileged PAT and manual review.
